open Lang.Common
open Containers

let%expect_test "fold_block" =
  let block =
    {|
   block %main_entry [
      var R31_in:bv64 := 1000:bv64;
      var R0_in:bv64 := 1000:bv64;
      $mem:(bv64->bv8) := store le $mem:(bv64->bv8) 0x420034:bv64 extract(32,0, R0_in:bv64) 32;
      unreachable;
      ]
    |}
  in
  let prog, proc, bl =
    Loader.Loadir.parse_single_block_proc ~proc:"test" block
  in
  CCIO.with_out "b.dot" (fun c ->
      Lang.Viscfg.Dot.fprint_graph (Format.of_chan c)
        (Lang.Procedure.graph proc |> Option.get_exn_or ""));
  let st, _ = Lang.Interp.run_prog prog in
  print_endline (Lang.Interp.IState.show st);
  ();
  [%expect {|
    PC= test::Return
    Stack

    Top frame:
    empty stack


    trace: Store {mem = "$mem"; addr = `Bitvector (0x420034:bv64);
          value = `Bitvector (0x3e8:bv32)}

    final mem state
    Mem $mem:(bv64->bv8)
    page at 420000
    000: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    010: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    020: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    030: 0000 0000 e803 0000 0000 0000 0000 0000  ................
    040: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    050: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    060: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    070: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    080: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    090: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    0a0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    0b0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    0c0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    0d0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    0e0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    0f0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    100: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    110: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    120: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    130: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    140: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    150: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    160: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    170: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    180: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    190: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    1a0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    1b0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    1c0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    1d0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    1e0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    1f0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    200: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    210: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    220: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    230: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    240: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    250: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    260: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    270: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    280: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    290: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    2a0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    2b0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    2c0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    2d0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    2e0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    2f0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    300: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    310: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    320: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    330: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    340: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    350: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    360: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    370: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    380: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    390: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    3a0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    3b0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    3c0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    3d0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    3e0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    3f0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
    |}]
